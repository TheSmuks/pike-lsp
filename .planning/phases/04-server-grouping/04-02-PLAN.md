---
phase: 04-server-grouping
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - packages/pike-lsp-server/src/features/navigation.ts
  - packages/pike-lsp-server/src/features/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "features/navigation.ts exports registerNavigationHandlers function"
    - "Hover handler returns type info and documentation"
    - "Definition handler jumps to symbol definition"
    - "References handler finds all symbol references"
    - "Each handler has try/catch with logger.error fallback"
  artifacts:
    - path: "packages/pike-lsp-server/src/features/navigation.ts"
      provides: "Navigation feature handlers"
      exports: ["registerNavigationHandlers"]
    - path: "packages/pike-lsp-server/src/features/index.ts"
      provides: "Feature module exports"
      exports: []
  key_links:
    - from: "features/navigation.ts"
      to: "services/index.ts"
      via: "import type Services"
      pattern: "import.*Services.*from.*services"
    - from: "features/navigation.ts"
      to: "vscode-languageserver"
      via: "import Connection"
      pattern: "import.*Connection.*from.*vscode-languageserver"
---

<objective>
Extract navigation handlers (hover, definition, references, highlight, declaration, typeDefinition, implementation) from server.ts into a dedicated feature module.

Purpose: Group "what is this symbol?" handlers together for better organization and maintainability.
Output: features/navigation.ts with registerNavigationHandlers function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Source code - server.ts handlers to extract
@packages/pike-lsp-server/src/server.ts

# Services created in 04-01
@.planning/phases/04-server-grouping/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract navigation handlers to features/navigation.ts</name>
  <files>packages/pike-lsp-server/src/features/navigation.ts</files>
  <action>
Create `packages/pike-lsp-server/src/features/navigation.ts`:

Extract the following handlers from server.ts into a `registerNavigationHandlers(connection, services)` function:

1. **onHover** (lines 908-1112 in server.ts)
2. **onDefinition** (lines 1116-1420 in server.ts)
3. **onDeclaration** (lines 1421-1448 in server.ts)
4. **onTypeDefinition** (lines 1449-1494 in server.ts)
5. **onImplementation** (lines 1495-1604 in server.ts)
6. **onReferences** (lines 1651-1743 in server.ts)
7. **onDocumentHighlight** (lines 3729-3786 in server.ts)

Pattern:
```typescript
import { Connection } from 'vscode-languageserver/node.js';
import type { Services } from '../services/index.js';
import type { LSPError } from '../core/errors.js';
import { PikeError } from '../core/errors.js';
import * as fs from 'fs/promises';

export function registerNavigationHandlers(
  connection: Connection,
  services: Services
): void {
  const { bridge, logger, documentCache, stdlibIndex } = services;
  const log = logger.child('navigation');

  // Extract connection.onHover handler here
  connection.onHover(async (params) => {
    log.debug('Hover request', { uri: params.textDocument.uri });
    try {
      // ... handler implementation from server.ts
    } catch (err) {
      log.error('Hover failed', { error: err instanceof Error ? err.message : String(err) });
      return null;
    }
  });

  // ... same pattern for other navigation handlers
}
```

Key changes:
1. Replace `connection.console.log` with `log.debug` or `log.info`
2. Wrap each handler in try/catch with `log.error` fallback (SRV-12)
3. Use `services.bridge`, `services.documentCache`, etc. instead of global variables
4. Keep helper functions like `findSymbolAtPosition`, `buildHoverContent`, `detectMemberAccessContext`, `getStdlibSymbol` inside the module (after the registration function)

DO NOT extract these utilities yet - keep them in navigation.ts for now:
- findSymbolAtPosition
- buildHoverContent
- convertSymbol
- detectMemberAccessContext
- getStdlibSymbol
- findSymbolByName
  </action>
  <verify>grep -q "export function registerNavigationHandlers" packages/pike-lsp-server/src/features/navigation.ts && grep -q "connection.onHover" packages/pike-lsp-server/src/features/navigation.ts && grep -q "connection.onDefinition" packages/pike-lsp-server/src/features/navigation.ts</verify>
  <done>features/navigation.ts exports registerNavigationHandlers with hover, definition, references, and other navigation handlers</done>
</task>

<task type="auto">
  <name>Task 2: Create features/index.ts barrel export</name>
  <files>packages/pike-lsp-server/src/features/index.ts</files>
  <action>
Create `packages/pike-lsp-server/src/features/index.ts`:

```typescript
export { registerNavigationHandlers } from './navigation.js';
```

This provides a clean import path for feature modules.
  </action>
  <verify>grep -q "registerNavigationHandlers" packages/pike-lsp-server/src/features/index.ts</verify>
  <done>features/index.ts re-exports all feature registration functions</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd packages/pike-lsp-server && npx tsc --noEmit`
2. All navigation handlers are exported from navigation.ts
3. Each handler has try/catch with logging fallback
</verification>

<success_criteria>
1. features/navigation.ts exists with registerNavigationHandlers
2. All 7 navigation handlers are registered in the function
3. Each handler has try/catch with logger.error
4. features/index.ts re-exports registerNavigationHandlers
</success_criteria>

<output>
After completion, create `.planning/phases/04-server-grouping/04-02-SUMMARY.md`
</output>
