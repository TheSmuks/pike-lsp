---
phase: 04-server-grouping
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - packages/pike-lsp-server/src/features/editing.ts
  - packages/pike-lsp-server/src/features/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "features/editing.ts exports registerEditingHandlers function"
    - "Completion handler provides code completion suggestions"
    - "Signature help handler shows function signatures"
    - "Rename handler renames symbols across files"
    - "Each handler has try/catch with logger.error fallback"
  artifacts:
    - path: "packages/pike-lsp-server/src/features/editing.ts"
      provides: "Editing feature handlers"
      exports: ["registerEditingHandlers"]
    - path: "packages/pike-lsp-server/src/features/index.ts"
      provides: "Feature module exports"
      exports: ["registerEditingHandlers"]
  key_links:
    - from: "features/editing.ts"
      to: "services/index.ts"
      via: "import type Services"
      pattern: "import.*Services.*from.*services"
    - from: "features/editing.ts"
      to: "vscode-languageserver"
      via: "import Connection"
      pattern: "import.*Connection.*from.*vscode-languageserver"
---

<objective>
Extract editing handlers (completion, signatureHelp, prepareRename, renameRequest) from server.ts into a dedicated feature module.

Purpose: Group "change this code" handlers together for better organization.
Output: features/editing.ts with registerEditingHandlers function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase intelligence
@.planning/intel/summary.md

# Source code - server.ts handlers to extract
@packages/pike-lsp-server/src/server.ts

# Services created in 04-01
@.planning/phases/04-server-grouping/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract editing handlers to features/editing.ts</name>
  <files>packages/pike-lsp-server/src/features/editing.ts</files>
  <action>
Create `packages/pike-lsp-server/src/features/editing.ts`:

Extract the following handlers from server.ts into a `registerEditingHandlers(connection, services)` function:

1. **onCompletion** (lines 1748-2028 in server.ts)
2. **onCompletionResolve** (lines 2029-2048 in server.ts)
3. **onSignatureHelp** (lines 2049-2197 in server.ts)
4. **onPrepareRename** (lines 2198-2227 in server.ts)
5. **onRenameRequest** (lines 2232-2376 in server.ts)

Pattern:
```typescript
import { Connection } from 'vscode-languageserver/node.js';
import type { Services } from '../services/index.js';
import type { LSPError } from '../core/errors.js';
import { PikeError } from '../core/errors.js';

export function registerEditingHandlers(
  connection: Connection,
  services: Services
): void {
  const { bridge, logger, documentCache, stdlibIndex, workspaceIndex } = services;
  const log = logger.child('editing');

  connection.onCompletion(async (params) => {
    log.debug('Completion request', { uri: params.textDocument.uri });
    try {
      // ... handler implementation from server.ts
    } catch (err) {
      log.error('Completion failed', { error: err instanceof Error ? err.message : String(err) });
      return [];
    }
  });

  // ... same pattern for other editing handlers
}
```

Key changes:
1. Replace `connection.console.log` with `log.debug` or `log.info`
2. Wrap each handler in try/catch with `log.error` fallback
3. Use `services.bridge`, `services.documentCache`, etc. instead of globals
4. Keep helper functions inside the module:
   - buildCompletionItem
   - getCompletionContext
   - convertCompletionKind

DO NOT touch these handlers - they belong in other feature files:
- onDocumentSymbol (symbols.ts)
- onWorkspaceSymbol (symbols.ts)
- publishDiagnostics (diagnostics.ts)
  </action>
  <verify>grep -q "export function registerEditingHandlers" packages/pike-lsp-server/src/features/editing.ts && grep -q "connection.onCompletion" packages/pike-lsp-server/src/features/editing.ts && grep -q "connection.onRenameRequest" packages/pike-lsp-server/src/features/editing.ts</verify>
  <done>features/editing.ts exports registerEditingHandlers with completion, signature help, and rename handlers</done>
</task>

<task type="auto">
  <name>Task 2: Update features/index.ts to export editing handlers</name>
  <files>packages/pike-lsp-server/src/features/index.ts</files>
  <action>
Update `packages/pike-lsp-server/src/features/index.ts`:

Add:
```typescript
export { registerEditingHandlers } from './editing.js';
```

Keep the existing registerNavigationHandlers export.
  </action>
  <verify>grep -q "registerEditingHandlers" packages/pike-lsp-server/src/features/index.ts</verify>
  <done>features/index.ts re-exports registerEditingHandlers</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd packages/pike-lsp-server && npx tsc --noEmit`
2. All editing handlers are exported from editing.ts
3. Each handler has try/catch with logging fallback
</verification>

<success_criteria>
1. features/editing.ts exists with registerEditingHandlers
2. All 5 editing handlers are registered in the function
3. Each handler has try/catch with logger.error
4. features/index.ts re-exports registerEditingHandlers
</success_criteria>

<output>
After completion, create `.planning/phases/04-server-grouping/04-03-SUMMARY.md`
</output>
