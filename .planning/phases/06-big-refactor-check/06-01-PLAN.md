---
phase: 06-big-refactor-check
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/tests/smoke-test.pike
  - scripts/run-pike-tests.sh
  - CONTRIBUTING.md
autonomous: true

must_haves:
  truths:
    - "Each .pike/.pmod file compiles standalone without errors"
    - "Each LSP module loads via master()->resolv() successfully"
    - "All 12 LSP handlers return valid JSON-RPC responses"
    - "Standalone smoke test file can be executed directly"
    - "Pre-merge checklist documented in CONTRIBUTING.md"
    - "Smoke test added to test runner script"
  artifacts:
    - path: "test/tests/smoke-test.pike"
      provides: "End-to-end LSP verification"
      min_lines: 100
    - path: "CONTRIBUTING.md"
      contains: "Pre-Merge Verification Checklist"
    - path: "scripts/run-pike-tests.sh"
      contains: "smoke-test.pike"
  key_links:
    - from: "test/tests/smoke-test.pike"
      to: "pike-scripts/LSP.pmod/module.pmod"
      via: "compile_file() and master()->resolv()"
      pattern: "compile_file|master\\(\\)->resolv"
    - from: "test/tests/smoke-test.pike"
      to: "test/tests/cross-version-tests.pike"
      via: "Reusing handler validation patterns"
      pattern: "parse_request|tokenize_request"
---

<objective>
Create a smoke test that validates the refactored LSP codebase works end-to-end, ensuring that module structure tests from Phase 5 translate to actual LSP functionality. This addresses the critical verification gap where 111 tests passed but real LSP features were never verified.

Purpose: Catch regressions that unit tests miss - particularly around module loading, JSON-RPC handler execution, and LSP response format - before code is merged.

Output: smoke-test.pike that validates standalone file compilation, module loading, and JSON-RPC handler responses, plus a mandatory pre-merge checklist in CONTRIBUTING.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-big-refactor-check/06-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md

# Existing test infrastructure (reuse patterns)
@test/tests/module-load-tests.pike
@test/tests/cross-version-tests.pike
@pike-scripts/analyzer.pike

# Test runner (to be updated)
@scripts/run-pike-tests.sh

# Documentation (to be updated)
@CONTRIBUTING.md
</context>

<tasks>

<task type="auto">
  <name>Create smoke-test.pike with end-to-end verification</name>
  <files>test/tests/smoke-test.pike</files>

  <action>
Create a comprehensive smoke test that validates:

1. **Standalone file compilation** (from RESEARCH.md Pattern 1):
   - Use compile_file() for each .pike/.pmod file
   - Files to test: analyzer.pike, module.pmod, Compat.pmod, Cache.pmod, Parser.pike, Intelligence.pike, Analysis.pike
   - Each should return a valid program (use programp() check)

2. **Module loading via resolver** (from RESEARCH.md Pattern 2):
   - Setup module path: master()->add_module_path("pike-scripts")
   - Test each module loads: LSP.module, LSP.Compat, LSP.Cache, LSP.Parser, LSP.Intelligence, LSP.Analysis
   - Verify each resolves to non-null value

3. **JSON-RPC handler smoke test** (from RESEARCH.md Pattern 3):
   - Instantiate each handler class (Parser, Intelligence, Analysis)
   - Call each handler with minimal valid params
   - Verify response has "result" field (JSON-RPC compliant)
   - Handlers to test: parse_request, tokenize_request, compile_request, batch_parse_request, handle_introspect, handle_resolve, handle_resolve_stdlib, handle_get_inherited, handle_find_occurrences, handle_analyze_uninitialized, handle_get_completion_context

Use the test framework pattern from cross-version-tests.pike:
- run_test() function with error handling
- Color output ([PASS]/[FAIL])
- Summary at end (tests run, passed, failed)
- Exit code 0 for all pass, 1 for any failure

DO NOT duplicate existing tests - this is a coordination layer that orchestrates verification patterns already established in module-load-tests.pike and cross-version-tests.pike.
  </action>

  <verify>
Run the smoke test directly: `pike test/tests/smoke-test.pike`

Expected output:
- "PASS" for each compilation test
- "PASS" for each module loading test
- "PASS" for each handler test
- Summary showing all tests passed
- Exit code 0
  </verify>

  <done>
All 7 Pike files compile standalone, all 6 modules load via resolver, all 11 handlers return valid JSON-RPC responses. Test executes in under 5 seconds.
  </done>
</task>

<task type="auto">
  <name>Add smoke test to test runner and CONTRIBUTING.md</name>
  <files>scripts/run-pike-tests.sh, CONTRIBUTING.md</files>

  <action>
**Part 1: Update run-pike-tests.sh**

Add smoke-test.pike as the FIRST test (fail-fast):
- Insert before "Test 1: Module loading tests"
- Use: `run_test "test/tests/smoke-test.pike" "End-to-End Smoke Test"`
- This ensures smoke test runs before all other tests

**Part 2: Add Pre-Merge Verification Checklist to CONTRIBUTING.md**

Insert a new section after "Testing Guidelines" and before "Code Style":

```markdown
## [Pre-Merge Verification Checklist]

Before submitting any pull request, complete these steps:

### Required (ALL PRs)

- [ ] **Run smoke test**: `./test/tests/smoke-test.pike`
  - Verify all 7 Pike files compile standalone
  - Verify all 6 LSP modules load successfully
  - Verify all 11 LSP handlers return valid JSON-RPC responses

- [ ] **Run full test suite**: `./scripts/run-pike-tests.sh`
  - All 111+ tests must pass
  - CI must pass on Pike 8.1116 (required)

- [ ] **If changing Pike scripts**: Rebundle extension
  - Run: `pnpm build` (calls bundle-server.sh)
  - Verify extension bundle includes updated pike-scripts

### Required for Pike Script Changes

- [ ] **Standalone compilation test**: `pike -e 'write("%d", programp(compile_file("your-file.pike")));'`
  - Must return 1 (valid program)

- [ ] **Module loading test**: After adding module path, verify `master()->resolv("LSP.YourModule")` returns non-null

- [ ] **Handler test**: Verify handler returns mapping with "result" field

### Optional (For LSP Feature Changes)

- [ ] **Manual extension test**: `./scripts/test-extension.sh path/to/test.pike`
  - Verify: No crash on file open
  - Verify: Completion works (type "Array." shows methods)
  - Verify: Hover shows type information
  - Verify: Go-to-definition navigates (Ctrl+click)

### Common Failure Patterns

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| compile_file() fails | Syntax error or missing import | Check Pike syntax, verify imports |
| master()->resolv() fails | Module path not set or wrong name | Call add_module_path() first, check module name |
| Handler returns error | Missing dependency or exception | Check handler logic, verify cache/parser available |
| Tests pass but extension fails | Bundle not rebuilt | Run `pnpm build` to rebundle |

> **Why this matters**: Phase 5 had 111 passing tests but actual LSP functionality was never verified. This checklist prevents that gap by requiring end-to-end verification before merges.
```
  </action>

  <verify>
1. Run updated test runner: `./scripts/run-pike-tests.sh`
   - Smoke test should run first
   - All tests should pass

2. Check CONTRIBUTING.md has new section:
   `grep -A 50 "Pre-Merge Verification Checklist" CONTRIBUTING.md`

3. Verify section is in correct position (between Testing Guidelines and Code Style)
  </verify>

  <done>
Smoke test runs first in test suite, CONTRIBUTING.md contains mandatory pre-merge verification checklist with clear required and optional steps.
  </done>
</task>

</tasks>

<verification>
After completion, verify:

1. **Smoke test exists**: `test/tests/smoke-test.pike` is executable
2. **Smoke test passes**: `pike test/tests/smoke-test.pike` returns exit code 0
3. **Test runner updated**: `scripts/run-pike-tests.sh` calls smoke-test.pike first
4. **Full test suite passes**: `./scripts/run-pike-tests.sh` completes successfully
5. **Documentation updated**: CONTRIBUTING.md contains "Pre-Merge Verification Checklist" section
6. **CI integration**: Smoke test runs before all other tests (fail-fast behavior)

Manual verification (optional but recommended):
- Run `./scripts/test-extension.sh test/fixtures/test.pike`
- Verify completion works when typing "Array."
- Verify hover shows type information
- Verify go-to-definition works with Ctrl+click
</verification>

<success_criteria>
1. smoke-test.pike validates all 7 Pike files compile standalone
2. smoke-test.pike validates all 6 LSP modules load via resolver
3. smoke-test.pike validates all 11 LSP handlers return valid JSON-RPC
4. Test runner executes smoke-test.pike as first test (fail-fast)
5. CONTRIBUTING.md documents mandatory pre-merge verification checklist
6. All existing tests (111+) continue to pass
7. Verification gap from Phase 5 is addressed
</success_criteria>

<output>
After completion, create `.planning/phases/06-big-refactor-check/06-01-SUMMARY.md` with:
- Smoke test results (compilation, module loading, handler validation)
- CONTRIBUTING.md changes (pre-merge checklist added)
- Test runner integration status
- Any issues discovered during smoke test execution
</output>
