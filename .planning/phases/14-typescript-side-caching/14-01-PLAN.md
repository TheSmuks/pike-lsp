---
phase: 14-typescript-side-caching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/pike-lsp-server/src/features/diagnostics.ts
  - packages/pike-lsp-server/src/services/bridge-manager.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All bridge.analyze() calls are logged with call site and timing"
    - "Log output shows whether multiple analyze() calls occur for same document version"
    - "Existing PikeBridge deduping behavior is observable via logs"
  artifacts:
    - path: "packages/pike-lsp-server/src/features/diagnostics.ts"
      contains: "connection.console.log.*ANALYZE_CALL"
    - path: "packages/pike-lsp-server/src/services/bridge-manager.ts"
      contains: "analyze.*log.*inflight"
  key_links:
    - from: "diagnostics.ts:validateDocument"
      to: "bridge-manager.ts:analyze"
      via: "bridge.analyze() call"
      pattern: "await bridge.analyze\\("
---

<objective>
Add request logging to verify if duplicate `analyze()` calls actually occur during document change events.

Purpose: The research found that PikeBridge already has inflight request deduping at the IPC level, and only `validateDocument()` calls `bridge.analyze()` after `didChange`. Before implementing TypeScript-side deduping, we need to verify if duplicate analyze() calls actually occur in practice.

Output: Logging instrumentation that captures all `analyze()` calls with their call sites, document versions, and timing to measure whether duplicate calls happen.
</objective>

<execution_context>
@~/.claude/get-shit-done/templates/CLAUDE.md
@.planning/PROJECT.md
@.planning/ROADMAP.md

@.planning/phases/14-typescript-side-caching/14-CONTEXT.md
@.planning/phases/14-typescript-side-caching/14-RESEARCH.md
@.planning/phases/13-pike-side-compilation-caching/13-04-SUMMARY.md

@packages/pike-lsp-server/src/features/diagnostics.ts
@packages/pike-lsp-server/src/services/bridge-manager.ts
@packages/pike-bridge/src/bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Add analyze call logging to BridgeManager</name>
  <files>packages/pike-lsp-server/src/services/bridge-manager.ts</files>
  <action>
    Add detailed logging to the `analyze()` method to track:
    1. Call entry with URI, version, and include array
    2. Whether an existing inflight request was detected (check `this.bridge.inflightRequests` size before/after)
    3. Call completion with timing and whether it was a cache hit (from `_perf.cache_hit`)

    Implementation:
    - Before calling `this.bridge.analyze()`, log `[ANALYZE_START] uri=..., version=..., include=...`
    - After call returns, log `[ANALYZE_DONE] uri=..., version=..., cache_hit=..., duration=...ms`
    - Use `performance.now()` for duration measurement

    DO NOT modify PikeBridge.ts - logging stays in TypeScript layer only.
  </action>
  <verify>grep -n "ANALYZE" packages/pike-lsp-server/src/services/bridge-manager.ts shows log entries at method entry and exit</verify>
  <done>BridgeManager.analyze() logs all calls with timing information</done>
</task>

<task type="auto">
  <name>Add didChange event logging to diagnostics.ts</name>
  <files>packages/pike-lsp-server/src/features/diagnostics.ts</files>
  <action>
    Add logging to track the sequence of events from document change to analyze call:
    1. Log `[DID_CHANGE] uri=..., version=...` when `validateDocumentDebounced` is called
    2. Log `[DEBOUNCE] uri=..., delay=...ms` when debounce timer executes
    3. Log `[VALIDATE_START] uri=..., version=...` at the start of `validateDocument()`

    This establishes the timeline from user edit to Pike analyze call.
  </action>
  <verify>grep -n "DID_CHANGE\|DEBOUNCE\|VALIDATE_START" packages/pike-lsp-server/src/features/diagnostics.ts shows event tracking</verify>
  <done>Full event sequence from didChange to analyze is logged</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Request logging instrumentation in BridgeManager and diagnostics.ts</what-built>
  <how-to-verify>
    1. Start the LSP server with logging enabled (it's already enabled via connection.console.log)
    2. Open a Pike file in VSCode
    3. Make several rapid edits (type quickly, then stop)
    4. Check the LSP server output logs (Output panel -> "Pike LSP")

    Expected observation:
    - Each edit triggers DID_CHANGE event with incrementing version number
    - Debounce timer fires (after ~500ms by default)
    - VALIDATE_START marks validation beginning
    - ANALYZE_START shows the analyze call parameters
    - ANALYZE_DONE shows result with timing

    Look for:
    - Multiple ANALYZE_START entries with same uri:version (would indicate duplicates)
    - Multiple concurrent VALIDATE_START entries for same document (race condition)
  </how-to-verify>
  <resume-signal>Type "observed" with your findings, or describe what you saw in the logs</resume-signal>
</task>

</tasks>

<verification>
After logging is in place and user verifies behavior:
- [ ] Logs show the sequence from didChange to analyze call
- [ ] Timing information is captured for each analyze call
- [ ] User can observe whether duplicate analyze() calls occur

If duplicates ARE observed: Proceed to plan 14-02 to implement RequestDeduper
If duplicates are NOT observed: Consider whether this phase should be skipped or the scope revised
</verification>

<success_criteria>
1. All analyze() calls are logged with URI, version, and timing
2. The full event chain from didChange to analyze is observable
3. User can make a data-driven decision about whether deduping is needed
</success_criteria>

<output>
After completion, create `.planning/phases/14-typescript-side-caching/14-01-SUMMARY.md`

The summary should include:
- What was observed in the logs (duplicate calls or not)
- Whether the analysis confirms or refutes the need for TypeScript-side deduping
- Recommendation for whether 14-02 should implement RequestDeduper or document that existing deduping is sufficient
</output>
