---
phase: 02-safety-net
plan: 02
type: execute
wave: 2
depends_on: [01-03]
files_modified: [packages/pike-lsp-server/src/tests/smoke.test.ts, packages/pike-lsp-server/package.json]
autonomous: true

must_haves:
  truths:
    - "Smoke test file exists in packages/pike-lsp-server/src/tests/smoke.test.ts"
    - "Smoke tests verify bridge lifecycle (start/stop without crash)"
    - "Smoke tests cover: parse returns array, introspect returns data, invalid Pike returns error"
    - "test:smoke script exists in pike-lsp-server package.json"
    - "Running 'pnpm --filter @pike-lsp/pike-lsp-server test:smoke' passes all tests"
  artifacts:
    - path: "packages/pike-lsp-server/src/tests/smoke.test.ts"
      provides: "Fast smoke test suite for LSP functionality"
      min_lines: 60
    - path: "packages/pike-lsp-server/package.json"
      provides: "test:smoke script entry"
      contains: '"test:smoke".*node --test.*smoke'
  key_links:
    - from: "pnpm --filter @pike-lsp/pike-lsp-server test:smoke"
      to: "dist/tests/smoke.test.js"
      via: "TypeScript compilation (tsc)"
      pattern: "tsc.*compiles.*src/tests.*dist/tests"
    - from: "smoke.test.ts"
      to: "@pike-lsp/pike-bridge"
      via: "ESM import"
      pattern: "import.*PikeBridge.*from.*@pike-lsp/pike-bridge"
---

<objective>
Create fast smoke test suite that verifies core LSP functionality without running full test suite.

Purpose: Provide quick feedback loop for pre-push hook and CI. Smoke tests validate the happy path: PikeBridge starts, responds to basic requests, and handles errors gracefully.

Output: Working smoke test suite that runs in under 10 seconds and validates core LSP operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-net/02-CONTEXT.md
@.planning/phases/02-safety-net/02-RESEARCH.md
@.planning/phases/01-lean-observability/01-03-SUMMARY.md
@packages/pike-bridge/src/bridge.ts
@packages/pike-lsp-server/package.json
@packages/pike-bridge/src/bridge.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test file with bridge lifecycle tests</name>
  <files>packages/pike-lsp-server/src/tests/smoke.test.ts</files>
  <action>
    Create packages/pike-lsp-server/src/tests/smoke.test.ts with the following content:

    ```typescript
    /**
     * LSP Smoke Tests
     *
     * Fast validation that core LSP functionality works.
     * Used by pre-push hooks and CI for quick feedback.
     */

    import { describe, it, before, after } from 'node:test';
    import assert from 'node:assert/strict';
    import { PikeBridge } from '@pike-lsp/pike-bridge';

    describe('LSP Smoke Tests', { timeout: 30000 }, () => {
      let bridge: PikeBridge;

      before(async () => {
        bridge = new PikeBridge();
        await bridge.start();
      });

      after(async () => {
        if (bridge) {
          await bridge.stop();
        }
      });

      it('responds to parse request with symbol array', async () => {
        const result = await bridge.parse('int x;', 'test.pike');

        // Verify we got a result
        assert.ok(result, 'Parse should return a result');

        // Verify symbols is an array (may be empty, but must exist)
        assert.ok(Array.isArray(result.symbols), 'symbols should be an array');
      });

      it('responds to introspect request', async () => {
        const code = 'int x = 1;';
        const result = await bridge.introspect(code, 'test.pike');

        // Verify we got a result
        assert.ok(result, 'Introspect should return a result');
      });

      it('handles invalid Pike gracefully (no crash)', async () => {
        // Invalid Pike syntax - should return diagnostics, not crash
        const result = await bridge.compile('int x = ;', 'test.pike');

        // Verify we got a result (not an exception)
        assert.ok(result, 'Compile should return result even for invalid syntax');

        // Verify diagnostics array exists (may be empty for parse, populated for compile)
        assert.ok(result.diagnostics !== undefined, 'Should have diagnostics field');
        assert.ok(Array.isArray(result.diagnostics), 'Diagnostics should be an array');
      });

      it('handles multiple requests without bridge restart', async () => {
        // Verify bridge stays alive across multiple requests
        const result1 = await bridge.parse('int a;', 'test1.pike');
        assert.ok(result1);

        const result2 = await bridge.parse('string b;', 'test2.pike');
        assert.ok(result2);

        const result3 = await bridge.introspect('float c = 1.0;', 'test3.pike');
        assert.ok(result3);
      });
    });
    ```

    Key design decisions:
    - Uses node:test pattern (consistent with existing tests)
    - 30 second timeout for entire suite (PikeBridge startup can be slow)
    - Tests happy path: parse works, introspect works, invalid input doesn't crash
    - Single bridge instance reused across tests (faster than start/stop per test)
    - Tests verify structure (arrays exist) not content (specific symbols)
  </action>
  <verify>
    - [ ] File created at packages/pike-lsp-server/src/tests/smoke.test.ts
    - [ ] Uses node:test imports (describe, it, before, after)
    - [ ] Imports PikeBridge from @pike-lsp/pike-bridge
    - [ ] Has 4 test cases: parse, introspect, invalid input, multiple requests
    - [ ] Tests verify structure (arrays, result exists) not specific values
  </verify>
  <done>
    Smoke test file created with 4 test cases covering bridge lifecycle, parse, introspect, and error handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test:smoke script to pike-lsp-server package.json</name>
  <files>packages/pike-lsp-server/package.json</files>
  <action>
    Add "test:smoke" script to packages/pike-lsp-server/package.json:

    In the "scripts" section, add:
    ```json
    "test:smoke": "pnpm build && node --test dist/tests/smoke.test.js"
    ```

    Order doesn't matter in package.json, but place it logically near the existing "test" script.

    NOTE: Script includes build step because tests must be compiled first (src/tests/*.ts -> dist/tests/*.js via tsc).
  </action>
  <verify>
    - [ ] package.json contains "test:smoke" script
    - [ ] Script includes "pnpm build" (or "tsc" for this package)
    - [ ] Script includes "node --test dist/tests/smoke.test.js"
    - [ ] Running `pnpm --filter @pike-lsp/pike-lsp-server test:smoke` from repo root works
  </verify>
  <done>
    test:smoke script added to pike-lsp-server package.json, successfully runs compiled smoke tests
  </done>
</task>

<task type="auto">
  <name>Task 3: Run smoke tests and verify all pass</name>
  <files>packages/pike-lsp-server/src/tests/smoke.test.ts</files>
  <action>
    1. Build the pike-lsp-server package to compile the test:
       ```bash
       pnpm --filter @pike-lsp/pike-lsp-server build
       ```

    2. Verify the compiled test file exists:
       ```bash
       ls -la packages/pike-lsp-server/dist/tests/smoke.test.js
       ```

    3. Run the smoke tests:
       ```bash
       pnpm --filter @pike-lsp/pike-lsp-server test:smoke
       ```

    4. Verify all 4 tests pass:
       - responds to parse request with symbol array
       - responds to introspect request
       - handles invalid Pike gracefully (no crash)
       - handles multiple requests without bridge restart

    5. Check that tests complete quickly (should be under 10 seconds):

    If any tests fail, debug by:
    - Checking if Pike is available: `pike --version`
    - Checking if analyzer.pike exists: `ls pike-scripts/analyzer.pike`
    - Running PikeBridge manually to see error messages
  </action>
  <verify>
    - [ ] smoke.test.js exists in dist/tests/
    - [ ] Running test:smoke shows "4 tests passed" (or similar)
    - [ ] All test names appear in output
    - [ ] No failures, no timeouts
    - [ ] Tests complete in under 10 seconds
  </verify>
  <done>
    All 4 smoke tests pass consistently, tests complete in under 10 seconds, ready for use in pre-push hook and CI
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. Smoke test file exists and compiles successfully
2. All 4 smoke tests pass:
   - Parse returns symbol array
   - Introspect returns data
   - Invalid Pike returns error (not crash)
   - Multiple requests work without restart
3. test:smoke script in package.json works
4. Tests complete in under 10 seconds
5. Pre-push hook (02-01) now runs smoke tests as part of validation
</verification>

<success_criteria>
1. packages/pike-lsp-server/src/tests/smoke.test.ts exists with 4 tests
2. Running `pnpm --filter @pike-lsp/pike-lsp-server test:smoke` passes all tests
3. Tests verify: parse returns array, introspect works, invalid input handled gracefully
4. Tests complete in under 10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-net/02-02-SUMMARY.md`
</output>
