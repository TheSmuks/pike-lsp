---
phase: 02-safety-net
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified: [.github/workflows/test.yml]
autonomous: true

must_haves:
  truths:
    - "CI pipeline runs on push to main and pull requests"
    - "CI installs Pike (pike8.0 from apt for reliability)"
    - "CI builds all packages (TypeScript compilation)"
    - "CI runs smoke tests (test:smoke from plan 02-02)"
    - "CI runs VSCode E2E tests with xvfb"
    - "CI fails fast if any step fails"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "GitHub Actions CI workflow"
      contains: "on:.*push.*pull_request"
    - path: ".github/workflows/test.yml"
      provides: "xvfb installation for VSCode E2E tests"
      contains: "xvfb"
    - path: ".github/workflows/test.yml"
      provides: "Pike installation step"
      contains: "apt-get.*pike"
  key_links:
    - from: "GitHub push event"
      to: ".github/workflows/test.yml"
      via: "workflow trigger"
      pattern: "on:\\s*push:"
    - from: "CI smoke test step"
      to: "packages/pike-lsp-server/src/tests/smoke.test.ts"
      via: "pnpm test:smoke command"
      pattern: "test:smoke"
---

<objective>
Extend existing CI pipeline to include smoke tests and VSCode E2E tests with xvfb.

Purpose: Ensure all pull requests and main branch pushes are validated automatically. CI provides the final safety net, catching issues that might slip through local pre-push hooks.

Output: CI pipeline that runs on push/PR, validates builds, runs smoke tests, and executes VSCode E2E tests with xvfb.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-net/02-CONTEXT.md
@.planning/phases/02-safety-net/02-RESEARCH.md
@.github/workflows/test.yml
@packages/vscode-pike/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pike installation to existing test job</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Modify .github/workflows/test.yml to add Pike installation in the existing "test" job.

    After the "Install dependencies" step, add a new step:

    ```yaml
    - name: Install Pike
      run: |
        sudo apt-get update
        sudo apt-get install -y pike8.0

    - name: Verify Pike installation
      run: |
        pike --version
        which pike
    ```

    Place this step AFTER "Install dependencies" and BEFORE "Build all packages".

    Rationale: Using pike8.0 from apt (not 8.1116 build) for the main test job ensures reliability. The pike-test job already handles cross-version testing including 8.1116.
  </action>
  <verify>
    - [ ] test.yml contains "Install Pike" step
    - [ ] Step uses "apt-get install -y pike8.0"
    - [ ] Step includes "Verify Pike installation" with version check
    - [ ] Step is positioned before build step
  </verify>
  <done>
    Pike installation added to test job, verifies pike --version works
  </done>
</task>

<task type="auto">
  <name>Task 2: Add smoke test step to CI test job</name>
  <files>.github/workflows/test.yml</files>
<action>
    Modify .github/workflows/test.yml to add a smoke test step.

    After the "Run LSP Server tests" step, add:

    ```yaml
    - name: Run LSP smoke tests
      run: pnpm --filter @pike-lsp/pike-lsp-server test:smoke
    ```

    This step runs the fast smoke tests created in plan 02-02, validating:
    - Bridge lifecycle (start/stop)
    - Parse returns array
    - Introspect returns data
    - Invalid Pike returns error (not crash)

    Place this AFTER "Run LSP Server tests" to keep related tests grouped.
  </action>
  <verify>
    - [ ] test.yml contains "Run LSP smoke tests" step
    - [ ] Step runs: "pnpm --filter @pike-lsp/pike-lsp-server test:smoke"
    - [ ] Step is positioned after "Run LSP Server tests"
  </verify>
  <done>
    Smoke test step added to CI, runs after LSP Server tests
  </done>
</task>

<task type="auto">
  <name>Task 3: Add VSCode E2E job with xvfb</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Add a new job at the end of .github/workflows/test.yml for VSCode E2E tests:

    ```yaml
    vscode-e2e:
      runs-on: ubuntu-24.04
      needs: [test, pike-test]

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Install pnpm
          uses: pnpm/action-setup@v2
          with:
            version: 8

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20.x'
            cache: pnpm

        - name: Install system dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y xvfb pike8.0

        - name: Install dependencies
          run: pnpm install

        - name: Build all packages
          run: pnpm build

        - name: Build VSCode extension tests
          run: pnpm --filter vscode-pike build:test

        - name: Run VSCode E2E tests
          run: xvfb-run --auto-servernum pnpm --filter vscode-pike test
    ```

    Key points:
    - needs: [test, pike-test] ensures unit tests pass before E2E runs
    - xvfb-run wraps the test command (VSCode needs X11 display on Linux)
    - Installs pike8.0 for the Pike subprocess
    - Builds extension tests before running

    Add this job AFTER the "build-extension" job, not before it (build-extension only runs on push to main, but vscode-e2e should run on all PRs).
  </action>
  <verify>
    - [ ] vscode-e2e job exists in test.yml
    - [ ] Job installs xvfb and pike8.0
    - [ ] Job uses xvfb-run to wrap test command
    - [ ] Job has needs: [test, pike-test] dependency
    - [ ] Job runs on ubuntu-24.04
  </verify>
  <done>
    VSCode E2E job added, runs with xvfb, depends on unit tests passing
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify CI workflow syntax and triggers</name>
  <files>.github/workflows/test.yml</files>
  <action>
    1. Verify workflow YAML syntax:
       ```bash
       # Check YAML is valid (no syntax errors)
       cat .github/workflows/test.yml
       ```

    2. Verify workflow triggers are correct:
       - on: push should include main and master branches
       - on: pull_request should include main and master branches

    3. Verify job dependencies:
       - vscode-e2e has needs: [test, pike-test]
       - build-extension has needs: [test, pike-test] and only runs on push to main

    4. Check for common issues:
       - No inconsistent indentation (YAML is space-sensitive)
       - All steps have dash prefix (-)
       - All run commands are properly quoted

    5. Create a summary of CI structure:
       - Job 1: test (TypeScript tests, now with Pike + smoke tests)
       - Job 2: pike-test (cross-version Pike handler tests)
       - Job 3: vscode-e2e (VSCode extension E2E with xvfb)
       - Job 4: build-extension (VSIX packaging, main branch only)

    Don't push or run the workflow - just verify it's syntactically correct and will work when triggered.
  </action>
  <verify>
    - [ ] YAML is valid (no syntax errors visible)
    - [ ] Triggers include push and pull_request
    - [ ] Pike installation uses apt (reliable pike8.0)
    - [ ] Smoke test step uses test:smoke script
    - [ ] xvfb-run wraps VSCode E2E tests
    - [ ] Job dependencies are correct (needs array)
  </verify>
  <done>
    CI workflow syntax verified, all jobs properly configured, ready for first run on next push/PR
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. CI workflow has Pike installation step
2. CI workflow has smoke test step
3. CI workflow has VSCode E2E job with xvfb
4. Job dependencies are correct (E2E waits for unit tests)
5. Workflow triggers on push to main and pull requests
6. YAML syntax is valid (no errors)
</verification>

<success_criteria>
1. .github/workflows/test.yml includes Pike installation (pike8.0 from apt)
2. Smoke test step runs pnpm --filter @pike-lsp/pike-lsp-server test:smoke
3. VSCode E2E job exists and uses xvfb-run
4. CI runs on push to main and pull requests
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-net/02-03-SUMMARY.md`
</output>
