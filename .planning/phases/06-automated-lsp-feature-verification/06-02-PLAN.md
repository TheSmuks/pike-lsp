---
phase: 06-automated-lsp-feature-verification
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .github/workflows/test.yml
  - .husky/pre-push
  - .claude/CLAUDE.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CI vscode-e2e job runs LSP feature tests and fails on feature regression"
    - "Pre-push hook includes E2E feature verification step"
    - "CLAUDE.md verification checklist references automated tests"
    - "CI blocks merge if LSP features return null/undefined"
    - "Test failures show which feature broke (symbols/hover/definition/completion)"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "E2E feature verification in CI"
      contains: "test:features|LSP.*feature"
    - path: ".husky/pre-push"
      provides: "Pre-push E2E feature check"
      contains: "test:features|LSP.*feature"
    - path: ".claude/CLAUDE.md"
      provides: "Updated verification checklist"
      contains: "automated.*test|LSP feature"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "vscode-e2e job"
      via: "Adds LSP feature verification step"
      pattern: "Run VSCode E2E.*test"
---

<objective>
Integrate LSP feature tests into CI pipeline and pre-push hooks to prevent regressions from merging.

Purpose: Automate the verification that was previously manual (CLAUDE.md checklist). Ensure every commit pushed/merged has working LSP features, not just passing unit tests.

Output: CI gates that block merges if hover/symbols/definition/completion broken
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-automated-lsp-feature-verification/06-RESEARCH.md
@.github/workflows/test.yml
@.husky/pre-push
@.claude/CLAUDE.md
</context>

## Tasks

### Task 1: Add LSP Feature Test Step to CI
**What:** Add step to vscode-e2e job that runs LSP feature tests
**Why:** Catch broken features before merge
**How:**
1. Open `.github/workflows/test.yml`
2. Locate `vscode-e2e` job (around line 186)
3. After "Run VSCode E2E tests" step, add new step:
   ```yaml
   - name: Run VSCode LSP Feature Tests
     run: xvfb-run --auto-servernum pnpm --filter vscode-pike test
   ```
4. Add failure message step:
   ```yaml
   - name: LSP Feature Test Summary
     if: always()
     run: |
       echo "### LSP Feature Tests" >> $GITHUB_STEP_SUMMARY
       echo "" >> $GITHUB_STEP_SUMMARY
       if [ $? -eq 0 ]; then
         echo "✓ All LSP features verified (symbols, hover, definition, completion)" >> $GITHUB_STEP_SUMMARY
       else
         echo "❌ LSP feature tests failed - verify features work in extension" >> $GITHUB_STEP_SUMMARY
       fi
   ```

### Task 2: Update Pre-Push Hook
**What:** Add E2E feature verification to pre-push validation
**Why:** Catch broken features before pushing (faster feedback than CI)
**How:**
1. Open `.husky/pre-push`
2. After smoke tests section (around line 33), add:
   ```bash
   # 4. VSCode E2E feature tests
   if [ -f "packages/vscode-pike/src/test/integration/lsp-features.test.ts" ]; then
     echo "[Pre-push] Running VSCode E2E feature tests..."
     cd packages/vscode-pike
     pnpm test || {
       echo "FAILED: VSCode E2E feature tests failed. Push aborted."
       echo "LSP features (symbols, hover, definition, completion) are broken."
       echo "Fix failing tests or use 'git push --no-verify' to bypass."
       exit 1
     }
     cd ../..
   else
     echo "[Pre-push] E2E feature tests not yet available (phase 06-01 pending)..."
   fi
   ```
3. Update final message to include E2E tests

### Task 3: Update CLAUDE.md Verification Section
**What:** Reference automated tests in manual verification checklist
**Why:** Developers should know tests exist and how to run them
**How:**
1. Open `.claude/CLAUDE.md`
2. Locate "MANDATORY: E2E Verification Before Commits" section (top of file)
3. Update verification checklist to include:
   ```markdown
   ### Automated Verification (Run These First)

   **VSCode E2E Feature Tests** (REQUIRED):
   ```bash
   # Tests LSP features end-to-end: symbols, hover, definition, completion
   cd packages/vscode-pike && pnpm test
   ```

   These tests verify:
   - Document symbols populate outline (not null)
   - Hover shows type information (not empty)
   - Go-to-definition navigates (not null)
   - Completion returns suggestions (not empty)

   **If E2E tests pass, LSP features work.** If they fail, debug before committing.
   ```
4. Keep existing manual smoke test section as additional verification
5. Add note: "Pre-push hook runs these automatically, but run manually for faster feedback"

### Task 4: Add Test Documentation to README
**What:** Document how to run E2E feature tests
**Why:** Contributors need to know tests exist
**How:**
1. Check if `packages/vscode-pike/README.md` exists
2. If exists, add "Testing" section:
   ```markdown
   ## Testing

   ### E2E Feature Tests

   Verify LSP features work end-to-end:

   ```bash
   cd packages/vscode-pike
   pnpm test
   ```

   Tests verify:
   - Document symbols (outline view)
   - Hover (type information)
   - Go-to-definition (navigation)
   - Completion (autocomplete)

   **Note:** Requires `xvfb` on Linux (pre-installed in CI).
   ```
3. If README doesn't exist, skip (optional nice-to-have)

### Task 5: Add CI Badge to README (Optional)
**What:** Add GitHub Actions badge showing test status
**Why:** Visible indication tests are passing
**How:**
1. Open main `README.md`
2. Add badge at top (if badges section exists):
   ```markdown
   ![CI Tests](https://github.com/pike-lsp/pike-lsp/workflows/Test/badge.svg)
   ```
3. Skip if no existing badges section (optional enhancement)

### Task 6: Test Pre-Push Hook Locally
**What:** Verify pre-push hook works before pushing
**Why:** Ensure hook doesn't break git workflow
**How:**
1. Make trivial change to force git diff
2. Run: `git add . && git commit -m "test: verify pre-push hook"`
3. Run: `git push origin <branch>` (or dry-run with --dry-run)
4. Verify hook runs E2E tests
5. Reset commit: `git reset HEAD~1`

### Task 7: Create Test Failure Debugging Guide
**What:** Add section to CLAUDE.md on debugging test failures
**Why:** Help developers fix broken features quickly
**How:**
1. In `.claude/CLAUDE.md`, add section:
   ```markdown
   ### Debugging E2E Test Failures

   **Symptom:** "Should return symbols (not null)" fails
   **Cause:** Document symbols not returned by LSP
   **Debug:**
   1. Check Pike analyzer compiles: `pike -e 'compile_file("pike-scripts/analyzer.pike");'`
   2. Check Bridge works: `cd packages/pike-bridge && pnpm test`
   3. Check LSP server logs: Look for "Error" in extension output
   4. Manual test: Open .pike file in VSCode, check Outline view

   **Symptom:** Test times out
   **Cause:** LSP server not starting
   **Debug:**
   1. Check extension activates: VSCode "Output" → "Pike Language Server"
   2. Increase timeout in test (current: 30s)
   3. Check Pike process: `ps aux | grep pike`
   ```

## Verification

**Success Criteria (must all pass):**
1. Push code to branch - CI runs vscode-e2e job with LSP feature tests
2. Check CI logs - "Run VSCode LSP Feature Tests" step exists and passes
3. Manually break a feature (comment out hover) - CI job fails
4. Run `git push` locally - pre-push hook runs E2E tests
5. Check `.claude/CLAUDE.md` - references automated tests
6. Test summary in CI shows which features passed/failed

**Files Modified:**
- `.github/workflows/test.yml` (add LSP feature test step to vscode-e2e job)
- `.husky/pre-push` (add E2E feature verification section)
- `.claude/CLAUDE.md` (update verification checklist with automated tests)
- `packages/vscode-pike/README.md` (optional, add testing documentation)

**Evidence:**
- CI run shows "Run VSCode LSP Feature Tests" step passing
- Pre-push hook output includes "[Pre-push] Running VSCode E2E feature tests..."
- CLAUDE.md shows "Automated Verification (Run These First)" section
- Breaking LSP features causes both CI and pre-push to fail

## Dependencies

**Requires from previous plans:**
- 06-01: LSP feature tests must exist and pass
- Phase 2: Pre-push hook infrastructure (Husky) installed
- Phase 2: CI vscode-e2e job with xvfb configured

**Provides for milestone:**
- Automated gate preventing broken LSP features from merging
- Developer confidence that tests catch regressions
- Documentation on running and debugging E2E tests

## Notes

- CI already has xvfb configured (from Phase 2), just add test step
- Pre-push hook optional for external contributors (can use --no-verify)
- Test failures should show clear error messages indicating which feature broke
- Keep manual verification in CLAUDE.md as backup (some bugs only in real editor)
- Consider adding test results to PR comments (future enhancement)
- Phase 6 completes v2 milestone with comprehensive automated verification
