---
phase: 06-automated-lsp-feature-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/vscode-pike/src/test/integration/lsp-features.test.ts
  - packages/vscode-pike/src/test/fixtures/test-lsp-features.pike
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Integration test calls vscode.executeDocumentSymbolProvider and verifies symbols array returned"
    - "Integration test calls vscode.executeHoverProvider and verifies MarkupContent returned"
    - "Integration test calls vscode.executeDefinitionProvider and verifies Location returned"
    - "Integration test calls vscode.executeCompletionItemProvider and verifies CompletionList returned"
    - "Tests fail if LSP features return null/undefined (regression detection)"
    - "Test fixture file contains known Pike constructs for predictable testing"
  artifacts:
    - path: "packages/vscode-pike/src/test/integration/lsp-features.test.ts"
      provides: "E2E tests for LSP features (symbols, hover, definition, completion)"
      min_lines: 150
    - path: "packages/vscode-pike/src/test/fixtures/test-lsp-features.pike"
      provides: "Test fixture with known Pike constructs"
      min_lines: 30
  key_links:
    - from: "packages/vscode-pike/src/test/integration/lsp-features.test.ts"
      to: "vscode.commands.executeCommand"
      via: "Uses VSCode API to test LSP features"
      pattern: "vscode.commands.executeCommand.*Provider"
---

<objective>
Create VSCode integration tests that verify LSP features (symbols, hover, definition, completion) return valid data end-to-end.

Purpose: Close the verification gap where extension activates and files open, but LSP features don't actually work. Current tests only check `document.languageId === 'pike'` - they don't verify hover shows type info or symbols populate the outline.

Output: Integration test file with 4+ tests that exercise full VSCode → LSP Server → Bridge → Pike path
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-automated-lsp-feature-verification/06-RESEARCH.md
@packages/vscode-pike/src/test/integration/extension.test.ts
@.claude/CLAUDE.md
</context>

## Tasks

### Task 1: Create Test Fixture File
**What:** Create Pike test file with known constructs for predictable testing
**Why:** Need stable test data - variables, functions, classes at known positions
**How:**
1. Create `packages/vscode-pike/src/test/fixtures/test-lsp-features.pike`
2. Add test constructs:
   - Variable declaration: `int test_variable = 42;`
   - Function with parameters: `int test_function(string arg) { return sizeof(arg); }`
   - Class with members: `class TestClass { int member; void method() {} }`
   - Stdlib usage for completion: `// Test completion: Array.`
3. Add comments documenting line numbers for position-based tests

### Task 2: Create Document Symbols Test
**What:** Test `textDocument/documentSymbol` returns symbols array
**Why:** Verifies outline/symbol tree feature works
**How:**
1. Create `packages/vscode-pike/src/test/integration/lsp-features.test.ts`
2. Import vscode, assert, test framework
3. Add suite 'LSP Feature E2E Tests'
4. Add test 'Document symbols returns valid symbol tree':
   - Open test fixture file
   - Execute `vscode.executeDocumentSymbolProvider`
   - Assert symbols is not null
   - Assert symbols is array with length > 0
   - Assert first symbol has name, kind, range
5. Set timeout 30000ms (allow LSP initialization)

### Task 3: Create Hover Test
**What:** Test `textDocument/hover` returns MarkupContent
**Why:** Verifies hover shows type information
**How:**
1. Add test 'Hover returns type information':
   - Open test fixture
   - Find position of `test_variable` (after 'int ')
   - Execute `vscode.executeHoverProvider` at position
   - Assert hovers is not null and length > 0
   - Assert hover contents exist
   - Assert content includes type info (contains 'int')

### Task 4: Create Go-to-Definition Test
**What:** Test `textDocument/definition` returns Location
**Why:** Verifies go-to-definition navigation works
**How:**
1. Add test 'Go-to-definition returns location':
   - Open test fixture
   - Find position of `test_variable` reference
   - Execute `vscode.executeDefinitionProvider` at position
   - Assert locations is not null and array
   - Assert locations length > 0
   - Assert first location has uri and range

### Task 5: Create Completion Test
**What:** Test `textDocument/completion` returns CompletionList
**Why:** Verifies autocomplete suggestions work
**How:**
1. Add test 'Completion returns suggestions':
   - Open test fixture
   - Find position after 'Array.' (stdlib completion trigger)
   - Execute `vscode.executeCompletionItemProvider` at position
   - Assert completions is not null
   - Assert completions.items exists and length > 0
   - Assert first item has label and kind

### Task 6: Add Test Cleanup
**What:** Clean up test fixtures after tests complete
**Why:** Prevent test file pollution
**How:**
1. Add `after()` hook in test suite
2. Delete created test files
3. Handle cleanup errors gracefully

### Task 7: Update Test Configuration
**What:** Ensure test file is included in test runs
**Why:** Tests need to be discovered and executed
**How:**
1. Verify `packages/vscode-pike/src/test/tsconfig.json` includes integration tests
2. Verify `packages/vscode-pike/package.json` test script includes integration tests
3. Add test:features script if needed: `"test:features": "node ./out/test/runTest.js"`

## Verification

**Success Criteria (must all pass):**
1. Run `pnpm --filter vscode-pike test` - all LSP feature tests pass
2. Check test output - 4+ tests run (symbols, hover, definition, completion)
3. Manually break a feature (e.g., comment out hover handler) - test fails
4. Test fixture file exists at expected path
5. All tests use `vscode.executeXProvider` pattern (not mocking)
6. Tests assert responses are non-null and have expected structure

**Files Modified:**
- `packages/vscode-pike/src/test/integration/lsp-features.test.ts` (new, 150+ lines)
- `packages/vscode-pike/src/test/fixtures/test-lsp-features.pike` (new, 30+ lines)
- `packages/vscode-pike/src/test/tsconfig.json` (updated includes if needed)

**Evidence:**
- Test output shows "LSP Feature E2E Tests" suite with 4+ passing tests
- Breaking LSP features causes tests to fail (regression detection works)

## Dependencies

**Requires from previous phases:**
- Phase 5: Pike modules must be working (Intelligence, Analysis)
- Extension activation works (from Phase 2 CI tests)
- PikeBridge operational (from Phase 3)

**Provides for next plan:**
- Test suite ready for CI integration
- Known test fixture file for E2E verification
- Automated LSP feature verification baseline

## Notes

- Tests use existing `@vscode/test-electron` infrastructure (already installed)
- No new dependencies needed - all VSCode API built-in
- Test fixture file should be added to git (stable test data)
- Tests require xvfb in CI (already configured in vscode-e2e job)
- Timeout set to 30s to allow LSP server initialization
- Follow existing test patterns from `extension.test.ts` for consistency
